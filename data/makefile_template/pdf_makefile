logdir = 
builddir = 
pandocfiles = 
mainfile = 

PD := /usr/local/bin/pandoc

mainfname = $(notdir $(mainfile))
mainbname = $(mainfname:%.md=%)
mainpdf = $(addprefix $(builddir)/,$(addsuffix .pdf,$(mainbname)))

auto_template_loc = $(logdir)/latextemplate.template

pandocflags  = -f markdown -t latex -s
pandocflags += --natbib --template=$(auto_template_loc) --lua-filter include-files.lua --lua-filter pandoc-gls.lua
pandocflags += --filter ./siunitx-filter.py --filter pandoc-crossref 
pandocflags += -M "crossrefYaml=~/.local/share/pandoc/defaults/pandoc-crossref-pandotfiles.yaml" -V 'lang=fr-CA' -V 'idhome=$HOME'
pandocflags += ~/.local/share/pandoc/defaults/latex_default-pandotfiles.yaml

texflag = -xelatex -f -cd -quiet -latexoption="-interaction=nonstopmode --shell-escape" -outdir="$(logdir)"

.PHONY: all clean

all : $(mainpdf)

clean: 
	-@ rm -r $(logdir) $(builddir)

$(mainpdf): $(mainfile) $(pandocfiles) $(EXTTARGETS) $(auto_template_loc)
	$(PD) $(pandocflags) -o pandoc_backup.tex $(mainfile)
	latexmk $(texflag) pandoc_backup.tex
	-@ mv pandoc_backup.tex $(logdir)
	-@ mkdir -p $(builddir)
	-@ mv $(logdir)/pandoc_backup.pdf $(mainpdf)

$(auto_template_loc): 
	-@ mkdir -p $(logdir)
	gen_latex_template > $(auto_template_loc)

open:
	-open $(mainpdf)
